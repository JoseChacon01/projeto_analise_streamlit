import streamlit as st
import pandas as pd
from datetime import datetime



# Configurar o tema da p√°gina
st.set_page_config(
    page_title="Projeto_Analise",
    page_icon="üìä",  
    layout="wide",
    initial_sidebar_state="expanded"
)




with st.container():
    st.title("Efici√™ncia Acad√™mica - 2021")
    st.write("Informa√ß√µes sobre o desempenho dos alunos dos Institutos Federais")
    st.write("DataSet disponivel em: [dadosabertos.mec.gov.br](https://dadosabertos.mec.gov.br/pnp/item/180-2021-microdados-eficiencia-academica)")




@st.cache_data
def carregar_dados():
    tabela = pd.read_csv("2021 - Efici√™ncia Acad√™mica.csv", delimiter=';')
    
    # Remover linhas em que todos os elementos s√£o nulos
    tabela_sem_nulos = tabela.dropna(how='all')
    
    return tabela_sem_nulos

with st.container():
    st.write("---")

    dados = carregar_dados()

    # Remover linhas onde 'Idade' √© nulo para a categoria 'Evadidos'
    dados_sem_nulos = dados.dropna(subset=['Idade'], inplace=False)

    st.subheader("Qual a m√©dia da idade dos alunos evadidos?")
    media_idade_evadidos = dados_sem_nulos.loc[dados_sem_nulos['Categoria da Situa√ß√£o'] == 'Evadidos', 'Idade'].mean()
    st.write("M√©dia da idade dos alunos evadidos (sem nulos):", media_idade_evadidos)

    st.subheader("Qual o desvio padr√£o da idade dos alunos evadidos?")
    desvio_padrao_idade_evadidos = dados_sem_nulos.loc[dados_sem_nulos['Categoria da Situa√ß√£o'] == 'Evadidos', 'Idade'].std()
    st.write("Desvio padr√£o da idade dos alunos evadidos (sem nulos):", desvio_padrao_idade_evadidos)

    # Gr√°fico de barras com m√©dia e desvio padr√£o
    st.bar_chart({"M√©dia": [media_idade_evadidos], "Desvio Padr√£o": [desvio_padrao_idade_evadidos]})





with st.container():
    st.write("---")
    st.subheader("Evas√£o por Institui√ß√µes")

    qnt_intituicoes = st.selectbox("Selecione a Quantidade", ["5", "10", "15", "20"])
    num_intituicoes = int(qnt_intituicoes)
    dados = carregar_dados()

    # Filtrando os dados para incluir apenas alunos evadidos
    alunos_evadidos = dados[dados['Categoria da Situa√ß√£o'] == 'Evadidos']

    top_instituicoes_evadidos = alunos_evadidos['Institui√ß√£o'].value_counts().head(num_intituicoes)

    if qnt_intituicoes == "5":
         st.subheader("Top 5 institui√ß√µes com a maior quantidade de alunos evadidos:")
    elif qnt_intituicoes == "10":
        st.subheader("Top 10 institui√ß√µes com a maior quantidade de alunos evadidos:")
    elif qnt_intituicoes == "15":
        st.subheader("Top 15 institui√ß√µes com a maior quantidade de alunos evadidos:")
    elif qnt_intituicoes == "20":
        st.subheader("Top 10 institui√ß√µes com a maior quantidade de alunos evadidos:")

    st.write(top_instituicoes_evadidos)
    st.bar_chart(top_instituicoes_evadidos)




with st.container():
    st.write("---")
    st.subheader("Concluintes por Institui√ß√µes")

    qnt_intituicoes_c = st.selectbox("Selecione a Quantidade", ["5", "10", "15", "20"], key="selectbox_concluintes")
    num_intituicoes_c = int(qnt_intituicoes_c)

    dados = carregar_dados()

    # Filtrando os dados para incluir apenas alunos concluintes
    alunos_concluintes = dados[dados['Categoria da Situa√ß√£o'] == 'Concluintes']

    # Obtendo as top 5 institui√ß√µes com a maior quantidade de alunos concluintes
    top_instituicoes_concluintes = alunos_concluintes['Institui√ß√£o'].value_counts().head(num_intituicoes_c)

    if qnt_intituicoes_c == "5":
         st.subheader("Top 5 institui√ß√µes com a maior quantidade de alunos concluintes:")
    elif qnt_intituicoes_c == "10":
        st.subheader("Top 10 institui√ß√µes com a maior quantidade de alunos concluintes:")
    elif qnt_intituicoes_c == "15":
        st.subheader("Top 15 institui√ß√µes com a maior quantidade de alunos concluintes:")
    elif qnt_intituicoes_c == "20":
        st.subheader("Top 10 institui√ß√µes com a maior quantidade de alunos concluintes:")


    st.write(top_instituicoes_concluintes)
    st.bar_chart(top_instituicoes_concluintes) 


with st.container():
    st.write("---")
    dados = carregar_dados()

    # Calculando a contagem de alunos por sexo
    contagem_alunos_por_sexo = dados['Sexo'].value_counts()

    # Filtrando alunos evadidos e concluintes
    alunos_evadidos = dados[dados['Categoria da Situa√ß√£o'] == 'Evadidos']
    alunos_concluintes = dados[dados['Categoria da Situa√ß√£o'] == 'Concluintes']

    # Calculando a contagem de evas√£o e concluintes por sexo
    evasao_por_sexo = alunos_evadidos['Sexo'].value_counts()
    concluintes_por_sexo = alunos_concluintes['Sexo'].value_counts()

    # Exibindo os resultados no Streamlit
    st.subheader("Contagem de alunos por sexo:")
    
    st.subheader("Masculino:")
    st.write("Matriculados:", contagem_alunos_por_sexo.get('Masculino', 0))
    st.write("Evas√£o:", evasao_por_sexo.get('Masculino', 0))
    st.write("Concluintes:", concluintes_por_sexo.get('Masculino', 0))

    st.write("\n")

    st.subheader("Feminino:")
    st.write("Matriculadas:", contagem_alunos_por_sexo.get('Feminino', 0))
    st.write("Evas√£o:", evasao_por_sexo.get('Feminino', 0))
    st.write("Concluintes:", concluintes_por_sexo.get('Feminino', 0))

     # Criando gr√°ficos com o formato padr√£o do Streamlit
    st.subheader("Contagem Total de Alunos por Sexo:")
    st.line_chart(contagem_alunos_por_sexo)

    st.subheader("Contagem de Evas√µes por Sexo:")
    st.line_chart(evasao_por_sexo)

    st.subheader("Contagem de Concluintes por Sexo:")
    st.line_chart(concluintes_por_sexo)





with st.container():
    dados = carregar_dados()

    # Filtrando alunos evadidos
    alunos_evadidos = dados[dados['Categoria da Situa√ß√£o'] == 'Evadidos']

    # Calculando a contagem de alunos por modalidade
    contagem_alunos_modalidade = dados['Modalidade de Ensino'].value_counts()

    # Calculando a contagem de evas√£o por modalidade
    evasao_por_modalidade = alunos_evadidos['Modalidade de Ensino'].value_counts()

    st.subheader("Contagem de Alunos e Evas√£o por Modalidade:")
    

    st.write("Alunos do Ensino Presencial:", contagem_alunos_modalidade.get('Educa√ß√£o Presencial', 0))
    st.write("Evaz√£o:", evasao_por_modalidade.get('Educa√ß√£o Presencial', 0))

    st.write("\n")

    st.write("Alunos da Ensino a Dist√¢ncia:", contagem_alunos_modalidade.get('Educa√ß√£o a Dist√¢ncia', 0))
    st.write("Evaz√£o:", evasao_por_modalidade.get('Educa√ß√£o a Dist√¢ncia', 0))


            # Criando gr√°fico com st.area_chart
    st.subheader("Gr√°fico de √Årea: Contagem de Alunos e Evas√£o por Modalidade")
    chart_data = pd.DataFrame({
        'Total de Alunos': contagem_alunos_modalidade,
        'Evas√£o': evasao_por_modalidade
    })

    st.area_chart(chart_data, use_container_width=True)    




with st.container():
    st.write("---")

    st.subheader("Evas√£o por estado")

    qnt_estados = st.selectbox("Selecione a Quantidade", ["5", "10", "15", "20"], key="chave_unica_para_o_selectbox")
    num_estados = int(qnt_estados)

    dados = carregar_dados()

    # Calculando a contagem de evas√£o por estado
    evasao_por_estado = dados[dados['Categoria da Situa√ß√£o'] == 'Evadidos']['UF'].value_counts()

    # Calculando a quantidade total de alunos por estado
    total_alunos_por_estado = dados['UF'].value_counts()

    # Calculando a taxa de evas√£o por estado
    taxa_evasao_por_estado = (evasao_por_estado / total_alunos_por_estado) * 100

    # Obtendo os estados com maior taxa de evas√£o
    top_estados_evasao = taxa_evasao_por_estado.sort_values(ascending=False).head(num_estados)

    if qnt_estados == "5":
         st.subheader("Top 5 estados com a maior quantidade de alunos evadidos:")
    elif qnt_estados == "10":
        st.subheader("Top 10 estados com a maior quantidade de alunos evadidos:")
    elif qnt_estados == "15":
        st.subheader("Top 15 estados com a maior quantidade de alunos evadidos:")
    elif qnt_estados == "20":
        st.subheader("Top 10 estados com a maior quantidade de alunos evadidos:")

    st.write(top_estados_evasao)
    st.bar_chart(top_estados_evasao)    

#--------------------------------------------------------------------------------------------
    # Obtendo os estados com maior taxa de evas√£o
    top_estados_evasao = taxa_evasao_por_estado.sort_values(ascending=True).head(num_estados)

    if qnt_estados == "5":
         st.subheader("Top 5 estados com a menor quantidade de alunos evadidos:")
    elif qnt_estados == "10":
        st.subheader("Top 10 estados com a menor quantidade de alunos evadidos:")
    elif qnt_estados == "15":
        st.subheader("Top 15 estados com a menor quantidade de alunos evadidos:")
    elif qnt_estados == "20":
        st.subheader("Top 10 estados com a menor quantidade de alunos evadidos:")

    st.write(top_estados_evasao)
    st.bar_chart(top_estados_evasao)    



with st.container():
    st.write("---")
    st.subheader("Quais s√£o os eixos?")
    dados = carregar_dados()

    tipos_de_eixos = dados['Eixo Tecnol√≥gico'].unique()

    # Criar um DataFrame para os eixos
    df_eixos = pd.DataFrame({'Eixos Tecnol√≥gicos': tipos_de_eixos})


    # Exibir a tabela de eixos
    st.table(df_eixos)



with st.container():
    st.write("---")
    st.subheader("Quantidade de alunos por eixo")
    dados = carregar_dados()

    # Contando a quantidade de matr√≠culas em cada eixo (Eixo Tecnol√≥gico)
    contagem_matriculas_por_eixo = dados['Eixo Tecnol√≥gico'].value_counts()


    st.write("Quantidade de matr√≠culas em cada eixo:")
    st.write(contagem_matriculas_por_eixo)
    st.bar_chart(contagem_matriculas_por_eixo) 




with st.container():
    st.write("---")
    st.subheader("Quantidade de evas√£o por eixo")
    dados = carregar_dados()

    # Filtrando os dados para incluir apenas alunos evadidos
    evadidos = dados[dados['Categoria da Situa√ß√£o'] == 'Evadidos']

    # Contando a quantidade de evas√µes por curso (Eixo Tecnol√≥gico)
    evasao_por_curso = evadidos['Eixo Tecnol√≥gico'].value_counts()

    st.write("Evas√£o por curso:")
    st.write(evasao_por_curso)
    st.bar_chart(evasao_por_curso) 




with st.container():
    st.write("---")
    st.subheader("Quais os turnos?")
    dados = carregar_dados()

    turnos_tipos = dados['Turno'].unique()

    # Criar um DataFrame para os turnos
    df_turnos = pd.DataFrame({'Turnos': turnos_tipos})

    # Exibir a tabela de turnos
    st.table(df_turnos)


with st.container():
    st.write("---")
    st.subheader("Quantidade de alunos matriculados por turno")
    dados = carregar_dados()

    # Corrige os valores dos turnos
    dados['Turno'] = dados['Turno'].replace({'Norturno': 'Noturno'})

    # Filtra os dados excluindo o turno "N√£o se aplica"
    dados_filtrados = dados[dados['Turno'] != 'N√£o se aplica']

    # Calcula a contagem de registros por turno
    contagem_registros_por_turno = dados_filtrados.groupby('Turno').size()

    st.write("Quantidade de registros por turno:")
    st.write(contagem_registros_por_turno)
    st.bar_chart(contagem_registros_por_turno) 




with st.container():
    st.write("---")
    st.subheader("Quantidade de evas√£o por turno")
    dados = carregar_dados()

    # Corrige os valores dos turnos
    dados['Turno'] = dados['Turno'].replace({'Norturno': 'Noturno'})

    # Filtra os dados de evas√£o excluindo o turno "N√£o se aplica"
    evasao_filtrada = dados[(dados['Categoria da Situa√ß√£o'] == 'Evadidos') & (dados['Turno'] != 'N√£o se aplica')]

    # Agrupando por turno e contando a quantidade de evas√µes
    quantidade_evasao_por_turno = evasao_filtrada.groupby('Turno').size()

    st.write("Quantitativo geral de evas√£o por turno:")
    st.write(quantidade_evasao_por_turno)
    st.bar_chart(quantidade_evasao_por_turno) 








with st.container():
    st.write("---")
    st.subheader("Filtrar registros dos alunos por data de matr√≠cula")

    dados = carregar_dados()

    # Convertendo a coluna 'Data de Ocorr√™ncia da Matr√≠cula' para o tipo datetime
    dados['Data de Ocorrencia da Matricula'] = pd.to_datetime(dados['Data de Ocorrencia da Matricula'], format='%d/%m/%Y', errors='coerce')

    # Adicionando widgets para a entrada de datas no formato brasileiro
    data_inicio, data_fim = st.date_input("Selecione a data de in√≠cio e t√©rmino:", min_value=dados['Data de Ocorrencia da Matricula'].min().date(), max_value=dados['Data de Ocorrencia da Matricula'].max().date(), value=[dados['Data de Ocorrencia da Matricula'].min().date(), dados['Data de Ocorrencia da Matricula'].max().date()], format="DD/MM/YYYY")

    # Convertendo as datas de entrada para datetime64[ns]
    data_inicio = pd.to_datetime(data_inicio, format='%d/%m/%Y')
    data_fim = pd.to_datetime(data_fim, format='%d/%m/%Y')

    # Filtrando os dados com base nas datas fornecidas pelo usu√°rio
    matriculas_filtradas = dados[(dados['Data de Ocorrencia da Matricula'] >= data_inicio) & (dados['Data de Ocorrencia da Matricula'] <= data_fim)]

    st.write(matriculas_filtradas.head(5))


